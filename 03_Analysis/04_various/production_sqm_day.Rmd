---
title: ""
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
```

**Purpose**: Calculate production per m2/day and standing biomass per m2 for whole simulation time for both movement treatments (*rand* vs. *attr*) and all treatment levels.

```{r load_data, message = FALSE}
# load packages #
source(here::here("01_Helper_functions/setup.R"))

source(here::here("01_Helper_functions/calc_seagrass_values.R"))

sim_experiment <- readr::read_rds(here::here("02_Data/02_Modified/03_run_model/sim_experiment.rds"))

model_runs <- readr::read_rds(here::here("02_Data/02_Modified/03_run_model/model_runs.rds"))

# add row id to sim_experiment
sim_experiment <- dplyr::mutate(sim_experiment, 
                                id = as.character(1:nrow(sim_experiment)), 
                                .before = "nutrients_pool")
```

For production to sum of all cells is divided by 100 x 100 cells and 50 years x 365 days, for standing biomass the sum of all cells is divided by 100 x 100 cells.

All values are the mean of all repetitions for the corresponding treatment level.

```{r calc_results}
# random movement # 
rand_prod <- purrr::map_dfr(model_runs, function(i) 
  magrittr::extract2(i, "rand") %>%
    magrittr::extract2("seafloor") %>% 
    dplyr::filter(timestep == max(timestep), reef == 0) %>% 
    dplyr::mutate(class_dist = cut(reef_dist, breaks = c(0, 10, 20, max(reef_dist)),
                                   ordered_result = TRUE)) %>% 
    dplyr::select(class_dist, ag_production, bg_production) %>% 
    tidyr::pivot_longer(cols = c(ag_production, bg_production), 
                        names_to = "part", values_to = "value") %>% 
    dplyr::group_by(class_dist, part) %>% 
    dplyr::summarise(value = mean(value), .groups = "drop"),
  .id = "id") %>% 
  dplyr::mutate(value = value / (50 * 365)) %>% 
  dplyr::left_join(sim_experiment, by = "id") %>% 
  dplyr::group_by(class_dist, part, nutrients_pool, pop_n) %>% 
  dplyr::summarise(value = mean(value), .groups = "drop") %>% 
  tidyr::pivot_wider(names_from = class_dist, values_from = value) %>% 
  dplyr::arrange(nutrients_pool, pop_n)

# attracted movement # 
attr_prod <- purrr::map_dfr(model_runs, function(i) 
  magrittr::extract2(i, "attr") %>%
    magrittr::extract2("seafloor") %>% 
    dplyr::filter(timestep == max(timestep), reef == 0) %>% 
    dplyr::mutate(class_dist = cut(reef_dist, breaks = c(0, 10, 20, max(reef_dist)),
                                   ordered_result = TRUE)) %>% 
    dplyr::select(class_dist, ag_production, bg_production) %>% 
    tidyr::pivot_longer(cols = c(ag_production, bg_production), 
                        names_to = "part", values_to = "value") %>% 
    dplyr::group_by(class_dist, part) %>% 
    dplyr::summarise(value = mean(value), .groups = "drop"),
  .id = "id") %>% 
  dplyr::mutate(value = value / (50 * 365)) %>% 
  dplyr::left_join(sim_experiment, by = "id") %>% 
  dplyr::group_by(class_dist, part, nutrients_pool, pop_n) %>% 
  dplyr::summarise(value = mean(value), .groups = "drop") %>% 
  tidyr::pivot_wider(names_from = class_dist, values_from = value) %>% 
  dplyr::arrange(nutrients_pool, pop_n)
```

Here are the results for *ag* and *bg* separated by movement type and treatment levels. You should be able to scroll down within the tables to see all values.

```{r results_rand_prod, echo = FALSE}
knitr::kable(rand_prod, caption = "Random movement production") %>% 
  kableExtra::kable_styling() %>% 
  kableExtra::scroll_box(height = "500px")
```

<br>
<br>

```{r results_attr_prod, echo = FALSE}
knitr::kable(attr_prod, caption = "Attracted movement production") %>% 
  kableExtra::kable_styling() %>% 
  kableExtra::scroll_box(height = "500px")
```

<br>
<br>
